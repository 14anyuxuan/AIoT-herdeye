{"ast":null,"code":"// 全局存储连接实例\nlet mainEs = null;\nlet mapEs = null;\n\n// 后端URL配置，可以放在环境变量中\nconst backendUrl = process.env.VUE_APP_BACKEND_URL || 'http://8.152.103.136:9090';\n\n// SSE连接通用方法\nexport const createSSE = (url, onMsg, onConn) => {\n  // 如果已有连接，先关闭\n  if (window.eventSource) {\n    window.eventSource.close();\n  }\n  const es = new EventSource(url);\n\n  // 存储到window，方便全局访问\n  window.eventSource = es;\n  es.addEventListener('connected', onConn);\n  es.onmessage = onMsg;\n  es.onerror = () => {\n    console.error('SSE连接错误，尝试重连...');\n    setTimeout(() => createSSE(url, onMsg, onConn), 5000);\n  };\n  return es;\n};\n\n// 主数据SSE连接\nexport const connectMainSSE = callbacks => {\n  // 如果已有连接，先关闭\n  if (mainEs) {\n    mainEs.close();\n  }\n  mainEs = createSSE(`${backendUrl}/sse/subscribe`, ev => {\n    try {\n      const data = JSON.parse(ev.data);\n      // 调用回调函数处理数据\n      if (callbacks.onMessage) {\n        callbacks.onMessage(data);\n      }\n      if (callbacks.onSuccess) {\n        callbacks.onSuccess();\n      }\n    } catch (e) {\n      console.error('解析主SSE失败:', e);\n      if (callbacks.onError) {\n        callbacks.onError(e);\n      }\n    }\n  }, () => {\n    if (callbacks.onConnect) {\n      callbacks.onConnect();\n    }\n  });\n  return mainEs;\n};\n\n// 地图SSE连接\nexport const connectMapSSE = callbacks => {\n  // 如果已有连接，先关闭\n  if (mapEs) {\n    mapEs.close();\n  }\n  mapEs = createSSE(`${backendUrl}/sse/subscribe`, ev => {\n    try {\n      const data = JSON.parse(ev.data);\n      // 调用回调函数处理数据\n      if (callbacks.onMessage) {\n        callbacks.onMessage(data);\n      }\n      if (callbacks.onSuccess) {\n        callbacks.onSuccess();\n      }\n    } catch (e) {\n      console.error('解析地图SSE失败:', e);\n      if (callbacks.onError) {\n        callbacks.onError(e);\n      }\n    }\n  }, () => {\n    if (callbacks.onConnect) {\n      callbacks.onConnect();\n    }\n  });\n  return mapEs;\n};\n\n// 关闭主SSE连接\nexport const closeMainSSE = () => {\n  if (mainEs) {\n    mainEs.close();\n    mainEs = null;\n  }\n};\n\n// 关闭地图SSE连接\nexport const closeMapSSE = () => {\n  if (mapEs) {\n    mapEs.close();\n    mapEs = null;\n  }\n};\n\n// 关闭所有SSE连接\nexport const closeAllSSE = () => {\n  closeMainSSE();\n  closeMapSSE();\n  if (window.eventSource) {\n    window.eventSource.close();\n    window.eventSource = null;\n  }\n};\n\n// 全局注册SSE服务方法\nexport const install = app => {\n  // 将SSE服务挂载到全局\n  app.config.globalProperties.$sse = {\n    createSSE,\n    connectMainSSE,\n    connectMapSSE,\n    closeMainSSE,\n    closeMapSSE,\n    closeAllSSE\n  };\n};\nexport default {\n  install\n};","map":{"version":3,"names":["mainEs","mapEs","backendUrl","process","env","VUE_APP_BACKEND_URL","createSSE","url","onMsg","onConn","window","eventSource","close","es","EventSource","addEventListener","onmessage","onerror","console","error","setTimeout","connectMainSSE","callbacks","ev","data","JSON","parse","onMessage","onSuccess","e","onError","onConnect","connectMapSSE","closeMainSSE","closeMapSSE","closeAllSSE","install","app","config","globalProperties","$sse"],"sources":["C:/Users/Q/Desktop/项目脚手架/manager/vue/src/views/sse.js"],"sourcesContent":["// 全局存储连接实例\r\nlet mainEs = null;\r\nlet mapEs = null;\r\n\r\n// 后端URL配置，可以放在环境变量中\r\nconst backendUrl = process.env.VUE_APP_BACKEND_URL || 'http://8.152.103.136:9090';\r\n\r\n// SSE连接通用方法\r\nexport const createSSE = (url, onMsg, onConn) => {\r\n  // 如果已有连接，先关闭\r\n  if (window.eventSource) {\r\n    window.eventSource.close();\r\n  }\r\n  \r\n  const es = new EventSource(url);\r\n  \r\n  // 存储到window，方便全局访问\r\n  window.eventSource = es;\r\n  \r\n  es.addEventListener('connected', onConn);\r\n  es.onmessage = onMsg;\r\n  \r\n  es.onerror = () => {\r\n    console.error('SSE连接错误，尝试重连...');\r\n    setTimeout(() => createSSE(url, onMsg, onConn), 5000);\r\n  };\r\n  \r\n  return es;\r\n};\r\n\r\n// 主数据SSE连接\r\nexport const connectMainSSE = (callbacks) => {\r\n  // 如果已有连接，先关闭\r\n  if (mainEs) {\r\n    mainEs.close();\r\n  }\r\n  \r\n  mainEs = createSSE(\r\n    `${backendUrl}/sse/subscribe`,\r\n    (ev) => {\r\n      try {\r\n        const data = JSON.parse(ev.data);\r\n        // 调用回调函数处理数据\r\n        if (callbacks.onMessage) {\r\n          callbacks.onMessage(data);\r\n        }\r\n        if (callbacks.onSuccess) {\r\n          callbacks.onSuccess();\r\n        }\r\n      } catch (e) {\r\n        console.error('解析主SSE失败:', e);\r\n        if (callbacks.onError) {\r\n          callbacks.onError(e);\r\n        }\r\n      }\r\n    },\r\n    () => {\r\n      if (callbacks.onConnect) {\r\n        callbacks.onConnect();\r\n      }\r\n    }\r\n  );\r\n  \r\n  return mainEs;\r\n};\r\n\r\n// 地图SSE连接\r\nexport const connectMapSSE = (callbacks) => {\r\n  // 如果已有连接，先关闭\r\n  if (mapEs) {\r\n    mapEs.close();\r\n  }\r\n  \r\n  mapEs = createSSE(\r\n    `${backendUrl}/sse/subscribe`,\r\n    (ev) => {\r\n      try {\r\n        const data = JSON.parse(ev.data);\r\n        // 调用回调函数处理数据\r\n        if (callbacks.onMessage) {\r\n          callbacks.onMessage(data);\r\n        }\r\n        if (callbacks.onSuccess) {\r\n          callbacks.onSuccess();\r\n        }\r\n      } catch (e) {\r\n        console.error('解析地图SSE失败:', e);\r\n        if (callbacks.onError) {\r\n          callbacks.onError(e);\r\n        }\r\n      }\r\n    },\r\n    () => {\r\n      if (callbacks.onConnect) {\r\n        callbacks.onConnect();\r\n      }\r\n    }\r\n  );\r\n  \r\n  return mapEs;\r\n};\r\n\r\n// 关闭主SSE连接\r\nexport const closeMainSSE = () => {\r\n  if (mainEs) {\r\n    mainEs.close();\r\n    mainEs = null;\r\n  }\r\n};\r\n\r\n// 关闭地图SSE连接\r\nexport const closeMapSSE = () => {\r\n  if (mapEs) {\r\n    mapEs.close();\r\n    mapEs = null;\r\n  }\r\n};\r\n\r\n// 关闭所有SSE连接\r\nexport const closeAllSSE = () => {\r\n  closeMainSSE();\r\n  closeMapSSE();\r\n  if (window.eventSource) {\r\n    window.eventSource.close();\r\n    window.eventSource = null;\r\n  }\r\n};\r\n\r\n// 全局注册SSE服务方法\r\nexport const install = (app) => {\r\n  // 将SSE服务挂载到全局\r\n  app.config.globalProperties.$sse = {\r\n    createSSE,\r\n    connectMainSSE,\r\n    connectMapSSE,\r\n    closeMainSSE,\r\n    closeMapSSE,\r\n    closeAllSSE\r\n  };\r\n};\r\n\r\nexport default { install };\r\n"],"mappings":"AAAA;AACA,IAAIA,MAAM,GAAG,IAAI;AACjB,IAAIC,KAAK,GAAG,IAAI;;AAEhB;AACA,MAAMC,UAAU,GAAGC,OAAO,CAACC,GAAG,CAACC,mBAAmB,IAAI,2BAA2B;;AAEjF;AACA,OAAO,MAAMC,SAAS,GAAGA,CAACC,GAAG,EAAEC,KAAK,EAAEC,MAAM,KAAK;EAC/C;EACA,IAAIC,MAAM,CAACC,WAAW,EAAE;IACtBD,MAAM,CAACC,WAAW,CAACC,KAAK,CAAC,CAAC;EAC5B;EAEA,MAAMC,EAAE,GAAG,IAAIC,WAAW,CAACP,GAAG,CAAC;;EAE/B;EACAG,MAAM,CAACC,WAAW,GAAGE,EAAE;EAEvBA,EAAE,CAACE,gBAAgB,CAAC,WAAW,EAAEN,MAAM,CAAC;EACxCI,EAAE,CAACG,SAAS,GAAGR,KAAK;EAEpBK,EAAE,CAACI,OAAO,GAAG,MAAM;IACjBC,OAAO,CAACC,KAAK,CAAC,iBAAiB,CAAC;IAChCC,UAAU,CAAC,MAAMd,SAAS,CAACC,GAAG,EAAEC,KAAK,EAAEC,MAAM,CAAC,EAAE,IAAI,CAAC;EACvD,CAAC;EAED,OAAOI,EAAE;AACX,CAAC;;AAED;AACA,OAAO,MAAMQ,cAAc,GAAIC,SAAS,IAAK;EAC3C;EACA,IAAItB,MAAM,EAAE;IACVA,MAAM,CAACY,KAAK,CAAC,CAAC;EAChB;EAEAZ,MAAM,GAAGM,SAAS,CAChB,GAAGJ,UAAU,gBAAgB,EAC5BqB,EAAE,IAAK;IACN,IAAI;MACF,MAAMC,IAAI,GAAGC,IAAI,CAACC,KAAK,CAACH,EAAE,CAACC,IAAI,CAAC;MAChC;MACA,IAAIF,SAAS,CAACK,SAAS,EAAE;QACvBL,SAAS,CAACK,SAAS,CAACH,IAAI,CAAC;MAC3B;MACA,IAAIF,SAAS,CAACM,SAAS,EAAE;QACvBN,SAAS,CAACM,SAAS,CAAC,CAAC;MACvB;IACF,CAAC,CAAC,OAAOC,CAAC,EAAE;MACVX,OAAO,CAACC,KAAK,CAAC,WAAW,EAAEU,CAAC,CAAC;MAC7B,IAAIP,SAAS,CAACQ,OAAO,EAAE;QACrBR,SAAS,CAACQ,OAAO,CAACD,CAAC,CAAC;MACtB;IACF;EACF,CAAC,EACD,MAAM;IACJ,IAAIP,SAAS,CAACS,SAAS,EAAE;MACvBT,SAAS,CAACS,SAAS,CAAC,CAAC;IACvB;EACF,CACF,CAAC;EAED,OAAO/B,MAAM;AACf,CAAC;;AAED;AACA,OAAO,MAAMgC,aAAa,GAAIV,SAAS,IAAK;EAC1C;EACA,IAAIrB,KAAK,EAAE;IACTA,KAAK,CAACW,KAAK,CAAC,CAAC;EACf;EAEAX,KAAK,GAAGK,SAAS,CACf,GAAGJ,UAAU,gBAAgB,EAC5BqB,EAAE,IAAK;IACN,IAAI;MACF,MAAMC,IAAI,GAAGC,IAAI,CAACC,KAAK,CAACH,EAAE,CAACC,IAAI,CAAC;MAChC;MACA,IAAIF,SAAS,CAACK,SAAS,EAAE;QACvBL,SAAS,CAACK,SAAS,CAACH,IAAI,CAAC;MAC3B;MACA,IAAIF,SAAS,CAACM,SAAS,EAAE;QACvBN,SAAS,CAACM,SAAS,CAAC,CAAC;MACvB;IACF,CAAC,CAAC,OAAOC,CAAC,EAAE;MACVX,OAAO,CAACC,KAAK,CAAC,YAAY,EAAEU,CAAC,CAAC;MAC9B,IAAIP,SAAS,CAACQ,OAAO,EAAE;QACrBR,SAAS,CAACQ,OAAO,CAACD,CAAC,CAAC;MACtB;IACF;EACF,CAAC,EACD,MAAM;IACJ,IAAIP,SAAS,CAACS,SAAS,EAAE;MACvBT,SAAS,CAACS,SAAS,CAAC,CAAC;IACvB;EACF,CACF,CAAC;EAED,OAAO9B,KAAK;AACd,CAAC;;AAED;AACA,OAAO,MAAMgC,YAAY,GAAGA,CAAA,KAAM;EAChC,IAAIjC,MAAM,EAAE;IACVA,MAAM,CAACY,KAAK,CAAC,CAAC;IACdZ,MAAM,GAAG,IAAI;EACf;AACF,CAAC;;AAED;AACA,OAAO,MAAMkC,WAAW,GAAGA,CAAA,KAAM;EAC/B,IAAIjC,KAAK,EAAE;IACTA,KAAK,CAACW,KAAK,CAAC,CAAC;IACbX,KAAK,GAAG,IAAI;EACd;AACF,CAAC;;AAED;AACA,OAAO,MAAMkC,WAAW,GAAGA,CAAA,KAAM;EAC/BF,YAAY,CAAC,CAAC;EACdC,WAAW,CAAC,CAAC;EACb,IAAIxB,MAAM,CAACC,WAAW,EAAE;IACtBD,MAAM,CAACC,WAAW,CAACC,KAAK,CAAC,CAAC;IAC1BF,MAAM,CAACC,WAAW,GAAG,IAAI;EAC3B;AACF,CAAC;;AAED;AACA,OAAO,MAAMyB,OAAO,GAAIC,GAAG,IAAK;EAC9B;EACAA,GAAG,CAACC,MAAM,CAACC,gBAAgB,CAACC,IAAI,GAAG;IACjClC,SAAS;IACTe,cAAc;IACdW,aAAa;IACbC,YAAY;IACZC,WAAW;IACXC;EACF,CAAC;AACH,CAAC;AAED,eAAe;EAAEC;AAAQ,CAAC","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}